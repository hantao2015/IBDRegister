## lz-request：丽章 http 请求库

### 一、安装

npm

```shell
npm install --save lz-request
```

yarn

```shell
yarn add lz-request
```

### 二、介绍

#### 1. `lz-request` 包含了一组丽章后端通用的 api:

- login：登录
- getTable：获取表格数据
- getSubTable：获取子表数据
- addRecords：添加记录
- modifyRecords：修改记录
- removeRecords：移除记录
- clearCache：清除后端缓存
- ...

使用实例：

```javascript
/**
 * 在 api.js 文件中
 * */
import http from 'lz-request/lib/http';

// ...
export default http;

// ===================================================

/**
 * 在 example.js 文件中使用通用的 api
 * */
import http from './api';
// ...其他代码
let res;
try {
  // 使用通用 api getTable 来获取资源 id 为 5050505050 表的数据
  res = await http().getTable({
    resid: 5050505050
  });
} catch (err) {
  return console.error(err);
}
//...其他代码
```

#### 2. `lz-request` 也包含了一套扩展 `定制 api` 的方法：

```javascript
// 例如：在 powerworks 项目中，需要定义一个 api，来获取网页头部的提醒数量

/**
 * api.js 文件
 * */
import http from 'lz-request/lib/http';

// 设置默认的基地址
http.setDefaultBaseURL('http://localhost:8080/');

// 设置默认的请求头
http.setDefaultHeaders({
  'Content-Type': 'application/json'
});

// 创建定制的获取提醒数量的 api，方法名为 'getReminderNum'
http.createApi('getReminderNum', {
  method: 'get', // 使用 get 方法
  url: '/api/Resource/RetrieveReminderNum' // 请求地址
});

export default http;

// ===================================================

/**
 * 在 header.js 组件中使用
 * */
import http from './api';
// ...其他代码

let res;
try {
  // 使用在 api.js 文件中创造出来的定制 api：getReminderNum()
  res = await http().getReminderNum();
} catch (err) {
  return console.error(err);
}

//...其他代码
```

### 三、http 下的方法

#### 1. http.setDefaultBaseURL(baseURL: string)：设置默认的基地址

- baseURL：基地址

如：

```javascript
// api.js
import http from 'lz-request';
http.setDefaultBaseURL('http://localhost:8080/');
```

#### 2. http.setDefaultHeaders(headers: object)：设置默认的请求头

- headers：请求头对象

如：

```javascript
// api.js
import http from 'lz-request';
http.setDefaultHeaders({
  'Content-Type': 'application/json'
});
```

#### 3. http.setRequestInterceptors(dealConfig: function, dealError: function)：设置请求拦截

- dealConfig：处理 config 且返回 config 的函数，默认为 `(config) => config`
- dealError：处理 error 且返回 error 的函数，默认为 `(error) => error`

如：

```javascript
// api.js
import http from 'lz-request';
http.setRequestInterceptors(
  function(config) {
    // 请求头加上 token
    let token;
    if ((token = localStorage.get('token'))) {
      config.headers.token = token;
    }
    return config;
  },
  function(error) {
    return error;
  }
);
```

4. http.setResponseInterceptors(dealReponse: function, dealError: function)：设置响应拦截

- dealReponse：处理 response 且返回 response 的函数，默认为 `(response) => response`
- dealError：处理 error 且返回 error 的函数，默认为 `(error) => error`

```javascript
// api.js
import http from 'lz-request';
http.setResponseInterceptors(
  function(response) {
    const res = response;
    // 判断请求是否成功
    if (res.error === 1) {
      throw new Error(res.message);
    }
    return config;
  },
  function(error) {
    return error;
  }
);
```

### 四、通用 api（除了 login api，其他 api 都需要加上 `accessToken` 和 `userCode` 请求头）

#### 3. http().getSubTable(params)：`get` 请求；获取子表数据

```javascript
await http().getSubTable({
  resid: number, // 子表资源 id
  subresid: number, // 子表资源 id
  hostrecid: number, // 主表记录 id
  cmswhere: string, // 子表查询语句
  key: string, // 模块查询
  cmscolumns: string, // 子表按需要的字段返回数据，字段之间使用 "," 隔开
  getcolumninfo: '0' | '1', // 是否返回字段定义：默认 '0'，不返回字段定义；'1' 返回字段定义
  pageindex: number, // 分页页码：默认 0 ，不分页
  pagesize: number // 分页大小
});
```

### 五、http(options: object)：返回一个 Request 实例对象

- options：选项
  - method：请求方法
  - baseURL：基地址
  - url：请求地址
  - headers：请求头
  - dealParams：处理参数的函数

使用场景：一般在 `api.js` 文件中，使用 `http.createApi('getData')` 方法创建了一个 `getData` 请求，如果使用 `api.js` 中设置的默认基地址：

```javascript
http().getData();
```

但有时候，我们想使用别的 `baseURL`（或 `method`、`url`、`headers`、`dealParams`），就可以传 `options` 给 `http()` 函数，来覆盖默认的选项：

```javascript
http({
  baseURL: 'https://others-base-url.com'
}).getData();
```

### 六、发布流程
1. 切换到 npm 源：npm set registry https://registry.npmjs.org/
2. npm 登录：npm login
3. babel 编译：npm run build
4. 更改版本号：npm version x.x.x
5. 发布到 npm：npm publish